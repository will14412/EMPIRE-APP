{% extends "layout.html" %}
{% block title %}Dashboard – Property Planner{% endblock %}
{% block content %}
  <h1 class="page-title">Dashboard</h1>
  <div class="dashboard-cards">
    <div class="card">
      <h2>Personal Portfolio Value</h2>
      <p class="value skeleton" data-value="£0.00"></p>
    </div>
    <div class="card">
      <h2>Company Portfolio Value</h2>
      {% if company_value %}
        <p class="value skeleton" data-value="£{{ '{:,.2f}'.format(company_value) }}"></p>
      {% else %}
        <p class="value empty-state">No data</p>
      {% endif %}
    </div>
    <div class="card">
      <h2>Company Cash</h2>
      {% if company_cash %}
        <p class="value skeleton" data-value="£{{ '{:,.2f}'.format(company_cash) }}"></p>
      {% else %}
        <p class="value empty-state">No data</p>
      {% endif %}
    </div>
    <div class="card">
      <h2>Properties — Personal</h2>
      {% if personal_count %}
        <p class="value skeleton" data-value="{{ personal_count }}"></p>
      {% else %}
        <p class="value empty-state">No properties</p>
      {% endif %}
    </div>
    <div class="card">
      <h2>Properties — Company</h2>
      {% if company_count %}
        <p class="value skeleton" data-value="{{ company_count }}"></p>
      {% else %}
        <p class="value empty-state">No properties</p>
      {% endif %}
    </div>
    <div class="card">
      <h2>Gross / Net Income</h2>
      <div class="toggle">
        <button class="{% if period == 'month' %}active{% endif %}" onclick="location.href='/?period=month'">Month</button>
        <button class="{% if period == 'year' %}active{% endif %}" onclick="location.href='/?period=year'">Year</button>
      </div>
      {% if gross_income or net_income %}
        <p class="value skeleton" data-value="£{{ '{:,.2f}'.format(gross_income) }} / £{{ '{:,.2f}'.format(net_income) }}"></p>
      {% else %}
        <p class="value empty-state">No data</p>
      {% endif %}
    </div>
    <div class="card">
      <h2>Refi Ready</h2>
      <table class="property-table">
        <thead>
          <tr>
            <th>Property</th>
            <th>LTV</th>
            <th>DSCR</th>
            <th>Est. Cash-Out</th>
          </tr>
        </thead>
        <tbody id="refi-table-body">
          <tr><td colspan="4" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.value.skeleton').forEach(el => {
        el.textContent = el.dataset.value;
        el.classList.remove('skeleton');
      });

      fetch('/refi/eligibility?company_id=1&limit=5&sort=-cash_out')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('refi-table-body');
          if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">No properties</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `\
              <td>${item.address}</td>
              <td>${(item.ltv * 100).toFixed(0)}%</td>
              <td>${Number(item.dscr).toFixed(2)}</td>
              <td>£${Number(item.cash_out).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tr.addEventListener('click', () => {
              window.location.href = '/properties/' + item.id;
            });
            tbody.appendChild(tr);
          });
        })
        .catch(() => {
          const tbody = document.getElementById('refi-table-body');
          tbody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load</td></tr>';
        });
    });
  </script>
{% endblock %}
