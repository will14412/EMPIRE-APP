{% extends "layout.html" %}
{% block title %}Add Property – Property Planner{% endblock %}
{% block content %}
  <h1 class="page-title">Add New Property</h1>
  <form action="/properties/add" method="post" class="form">
    <div class="form-group">
      <label for="postcode">Postcode</label>
      <input type="text" id="postcode" placeholder="Enter postcode" />
    </div>
    <div class="form-group">
      <label for="address">Address</label>
      <select id="address" name="address">
        <option value="">Select an address</option>
      </select>
    </div>
    <div class="form-group">
      <label for="name">Name</label>
      <input type="text" id="name" name="name" required />
    </div>
    <div class="form-group">
      <label for="value">Value (£)</label>
      <input
        type="number"
        id="value"
        name="value"
        step="0.01"
        min="0"
        required
      />
    </div>
    <div class="form-group">
      <label for="type">Type</label>
      <select id="type" name="type" required>
        <option value="personal">Personal</option>
        <option value="company">Company</option>
      </select>
    </div>
    <h2 class="section-title">Lease</h2>
    <div class="form-group">
      <label for="lease_type">Lease type</label>
      <select id="lease_type" name="lease_type">
        <option value="council_20">Council 20 Year</option>
        <option value="council_7">Council 7 Year</option>
        <option value="ast">AST</option>
        <option value="hmo">HMO</option>
      </select>
    </div>
    <div class="form-group">
      <label for="rent_input_type">Monthly rent input</label>
      <select id="rent_input_type">
        <option value="currency">£</option>
        <option value="percent">%</option>
      </select>
    </div>
    <div class="form-group" id="rent_percent_group" style="display: none;">
      <label for="monthly_rent_percent">Monthly rent (%)</label>
      <input type="number" id="monthly_rent_percent" step="0.01" min="0" />
    </div>
    <div class="form-group">
      <label for="monthly_rent">Monthly rent (£)</label>
      <input type="number" id="monthly_rent" name="monthly_rent" step="0.01" min="0" />
    </div>
    <div class="form-group">
      <label for="indexation_type">Indexation type</label>
      <select id="indexation_type" name="indexation_type">
        <option value="none">None</option>
        <option value="fixed">Fixed</option>
        <option value="cpi">CPI</option>
      </select>
    </div>
    <div class="form-group">
      <label for="indexation_rate">Indexation rate (%)</label>
      <input type="number" id="indexation_rate" name="indexation_rate" step="0.01" min="0" />
    </div>
    <div class="form-group">
      <label for="lease_start">Lease start date</label>
      <input type="date" id="lease_start" name="lease_start" />
    </div>
    <div class="form-group">
      <label for="lease_end">Lease end date</label>
      <input type="date" id="lease_end" name="lease_end" />
    </div>

    <h2 class="section-title">Mortgage</h2>
    <div class="form-group">
      <label for="has_mortgage">Has mortgage?</label>
      <select id="has_mortgage" name="has_mortgage">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </div>
    <div id="mortgage_fields" style="display: none; gap: 1rem;">
      <div class="form-group">
        <label for="lender_name">Lender name</label>
        <input type="text" id="lender_name" name="lender_name" />
      </div>
      <div class="form-group">
        <label for="loan_amount">Loan amount (£)</label>
        <input type="number" id="loan_amount" name="loan_amount" step="0.01" min="0" />
      </div>
      <div class="form-group">
        <label for="interest_rate">Interest rate (%)</label>
        <input type="number" id="interest_rate" name="interest_rate" step="0.01" min="0" />
      </div>
      <div class="form-group">
        <label for="repayment_type">Repayment type</label>
        <select id="repayment_type" name="repayment_type">
          <option value="interest_only">Interest-only</option>
          <option value="repayment">Repayment</option>
        </select>
      </div>
      <div class="form-group">
        <label for="mortgage_term">Term (years)</label>
        <input type="number" id="mortgage_term" name="mortgage_term" min="0" />
      </div>
    </div>
    <button type="submit" class="btn">Add Property</button>
  </form>
  <script>
    const GET_ADDRESS_API_KEY = "MR3OmMfdukGPgl0gW_Ztxw44533"; // Replace with your API key
    const addressSelect = document.getElementById("address");
    const nameInput = document.getElementById("name");
    const rentInputType = document.getElementById("rent_input_type");
    const rentPercentGroup = document.getElementById("rent_percent_group");
    const rentPercentInput = document.getElementById("monthly_rent_percent");
    const monthlyRentInput = document.getElementById("monthly_rent");
    const propertyValueInput = document.getElementById("value");
    const leaseTypeSelect = document.getElementById("lease_type");
    const leaseStartInput = document.getElementById("lease_start");
    const leaseEndInput = document.getElementById("lease_end");
    const hasMortgageSelect = document.getElementById("has_mortgage");
    const mortgageFields = document.getElementById("mortgage_fields");

    document.getElementById("postcode").addEventListener("change", async function () {
      const postcode = this.value.trim();
      addressSelect.innerHTML = '<option value="">Loading...</option>';
      if (!postcode) {
        addressSelect.innerHTML = '<option value="">Select an address</option>';
        return;
      }
      try {
        const response = await fetch(
          `https://api.getAddress.io/find/${encodeURIComponent(postcode)}?api-key=${GET_ADDRESS_API_KEY}`
        );
        if (!response.ok) {
          throw new Error("Lookup failed");
        }
        const data = await response.json();
        addressSelect.innerHTML = "";
        data.addresses.forEach((addr) => {
          const cleanedAddr = addr
            .split(",")
            .map((part) => part.trim())
            .filter((part) => part)
            .join(", ");
          const option = document.createElement("option");
          option.value = cleanedAddr;
          option.textContent = cleanedAddr;
          addressSelect.appendChild(option);
        });
      } catch (err) {
        addressSelect.innerHTML = '<option value="">No addresses found</option>';
      }
    });

    addressSelect.addEventListener("change", () => {
      const selected = addressSelect.value;
      const firstPart = selected.split(",")[0].trim();
      nameInput.value = firstPart;
    });

    rentInputType.addEventListener("change", () => {
      if (rentInputType.value === "percent") {
        rentPercentGroup.style.display = "flex";
        monthlyRentInput.readOnly = true;
        monthlyRentInput.value = "";
      } else {
        rentPercentGroup.style.display = "none";
        monthlyRentInput.readOnly = false;
      }
    });

    function updateMonthlyRent() {
      const value = parseFloat(propertyValueInput.value);
      const percent = parseFloat(rentPercentInput.value);
      if (!isNaN(value) && !isNaN(percent)) {
        monthlyRentInput.value = (value * (percent / 100)).toFixed(2);
      } else {
        monthlyRentInput.value = "";
      }
    }

    rentPercentInput.addEventListener("input", updateMonthlyRent);
    propertyValueInput.addEventListener("input", () => {
      if (rentInputType.value === "percent") updateMonthlyRent();
    });

    function updateLeaseEnd() {
      const startDate = new Date(leaseStartInput.value);
      if (isNaN(startDate)) {
        leaseEndInput.value = "";
        return;
      }
      let years = 0;
      if (leaseTypeSelect.value === "council_20") years = 20;
      else if (leaseTypeSelect.value === "council_7") years = 7;
      if (years > 0) {
        const endDate = new Date(startDate);
        endDate.setFullYear(endDate.getFullYear() + years);
        leaseEndInput.value = endDate.toISOString().split("T")[0];
      }
    }

    leaseTypeSelect.addEventListener("change", updateLeaseEnd);
    leaseStartInput.addEventListener("change", updateLeaseEnd);

    hasMortgageSelect.addEventListener("change", () => {
      mortgageFields.style.display =
        hasMortgageSelect.value === "yes" ? "grid" : "none";
    });
  </script>
{% endblock %}
